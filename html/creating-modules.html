<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Creating modules</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery.min.js"></script>
    <script src="jquery.powertip.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="doxy-jquery.js"></script>
    <script src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <!-- Bootstrap -->
    <link href="doxygen.css" rel="stylesheet">
    <link href="fonts.css" rel="stylesheet">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
    <link href="riot.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
        <script>
            function displaySR(){
            searchBox.Search();
            var rhtml=(document.getElementById('MSearchResults').contentWindow.document.body.innerHTML).replace(/href=\"\.\.\//g,'href="');
            document.getElementById('MSearchResultsWindow').style.display='none';
            document.getElementById('top').append(document.getElementById('MSearchSelectWindow'));
            document.getElementById('top').append(document.getElementById('MSearchResultsWindow'));
            document.getElementById('doc-content').innerHTML=rhtml;
            }
            function modSearch(){
            if(!searchBox.doxySearch){
                searchBox.doxySearch=searchBox.Search
                searchBox.Search= function(){this.doxySearch();
                var r=document.getElementById('MSearchResultsWindow');console.log(r.style);
                if(parseInt(r.style.left)<0)r.style.left=0;
                var x=document.getElementById('MSearchResults');
                if(x.scrollWidth>window.screen.width)x.style.width=window.screen.width-2+'px';
                var f=document.getElementById('riot-searchform');
                if(parseInt( r.style.top) < f.offsetTop+f.scrollHeight) r.style.top = f.offsetTop+f.scrollHeight+'px';}
            }
            }
        </script>
  </head>
  <body>
      <div id="top">
        <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" id="brand-logo" href="http://riot-os.org"><img height="40px" src="riot-logo.svg" /></a>
              <p class="navbar-text text-center visible-xs">Documentation</p>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="navbar-collapse">
              <p class="navbar-text navbar-left"><span id="projectbrief">The friendly Operating System for the Internet of Things</span></p>
              <ul id="riot-navlist" class="nav navbar-nav"></ul>
              <form id="riot-searchform" class="navbar-form navbar-left navbar-right"
                    onsubmit="try{
                        displaySR();
                    }finally{
                            return false;
                    }">
                 <div class="form-group">
                   <div id="MSearchBox" class="MSearchBoxActive">
                     <div class="input-group">
                       <div class="input-group-addon">
                         <span id="MSearchSelect" class="glyphicon glyphicon-search" aria-hidden="true" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"></span>
                       </div>
                       <input class="form-control" type="text" id="MSearchField" placeholder="Search" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event); modSearch();">
                       <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()">
                         <span id="search-reset" class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                       </a>
                     </div>
                   </div>
                 </div>
              </form>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
      </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('creating-modules.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Creating modules </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Modules in RIOT are well-defined units of code that provide a set of features to your application. This includes also drivers and to a certain extent ports for CPUs and boards (with some exceptions, see the porting guide for further information).</p>
<h1><a class="anchor" id="the-general-structure"></a>
The general structure                                  </h1>
<p>Like <a class="el" href="creating-an-application.html">applications</a>, modules are directories containing source files and a Makefile. Additionally their API can be defined in one or more header files, residing in the include path of their super-module.</p>
<p>E.g. the <a class="el" href="group__sys__shell.html">Shell</a> module is implemented in <code>sys/shell</code> and defines its API in <code><a class="el" href="shell_8h.html" title="Shell interface definition. ">sys/include/shell.h</a></code> and the <a class="el" href="group__drivers__isl29020.html">ISL29020 light sensor</a> driver is implemented in <code>drivers/isl29020</code> and defines its API in <code><a class="el" href="isl29020_8h.html" title="Device driver interface for the ISL29020 light sensor. ">drivers/include/isl29020.h</a></code>.</p>
<p>A module's Makefile just needs to include <code>Makefile.base</code> in the RIOT repository:</p>
<div class="fragment"><div class="line">include $(RIOTBASE)/Makefile.base</div></div><!-- fragment --><p>If your module's name differs from the name of the directory it resides in you need to set the <code>MODULE</code> macro in addition.</p>
<p>When compiled a module always provides a <code>MODULE_&lt;MODULENAME&gt;</code> macro to the system. This way, other modules can check if the module is available in the current configuration or not.</p>
<p>Modules can be used by adding their name to the <code>USEMODULE</code> macro of your application's Makefile.</p>
<h3>Pitfalls</h3>
<p>The <code>MODULE</code> name should be unique or build breaks as modules overwrite the same output file. This might for example lead to <code>undefined reference to</code> errors in the linker which can be hard to track down.</p>
<p>This problem happened in the past for:</p>
<ul>
<li>Packages root directory (libfixmath/u8g2)</li>
<li>boards/cpu/periph and their common boards/cpu/periph</li>
</ul>
<p>Note: even if all boards and cpus implement the <code>board</code> and <code>cpu</code> modules, only one is used in an application so there is no conflict.</p>
<h1>Module dependencies </h1>
<p>Your module may depend on other modules to minimize code duplication. These dependencies are defined in <code>Makefile.dep</code> with the following syntax:</p>
<div class="fragment"><div class="line">ifneq (,$(filter your_module,$(USEMODULE))) # if module in USEMODULE</div><div class="line">  USEMODULE += dep1                         # add dependencies to USEMODULE</div><div class="line">  USEMODULE += dep2</div><div class="line">endif</div></div><!-- fragment --><p>Note, that <code>Makefile.dep</code> is processed only once so you have to take care to add the dependency block for your module <em>before</em> your dependencies pull in their dependencies.</p>
<h1><a class="anchor" id="modules-outside-of-riotbase"></a>
Modules outside of RIOTBASE                      </h1>
<p>Modules can be defined outside <code>RIOTBASE</code>. In addition to add it to <code>USEMODULE</code> the user needs to add the module path to <code>EXTERNAL_MODULE_DIRS</code>.</p>
<p>The external module can optionally define the following files:</p><ul>
<li><code>Makefile.include</code> file to set global build configuration like <code>CFLAGS</code> or add API headers include paths to the <code>USEMODULE_INCLUDES</code> variable.</li>
<li><code>Makefile.dep</code> file to set module dependencies</li>
</ul>
<p>An example can be found in <a href="https://github.com/RIOT-OS/RIOT/tree/master/tests/external_module_dirs"><code>tests/external_module_dirs</code></a></p>
<h1><a class="anchor" id="pseudomodules"></a>
Pseudomodules                                                  </h1>
<p>Pseudomodules are modules that are not static libraries, i.e. do not generate a <code>&lt;module name&gt;.a</code> file.</p>
<p>To create a pseudomodule just add its name to <code>makefiles/pseudomodules.inc.mk</code> with <code>PSEUDOMODULES += &lt;modulename&gt;</code> in alphabetical order.</p>
<p>A Pseudomodule may or may not have a source file associated with it. To make the distinction between them we will refer to those that don't as true-Pseudomodules.</p>
<p>The main use case for true-Pseudomodules is to provide base information for dependencies to other modules or information to the code base via the <code>MODULE_&lt;MODULENAME&gt;</code> macro.</p>
<p>Pseudomodules with source code exist under a "real" <code>MODULE</code> since they will generate a <code>&lt;pseudomodule_name&gt;.o</code> file grouped under that <code>MODULE</code>s <code>&lt;module_name&gt;.a</code> file.</p>
<p>These modules appear in RIOT under two forms:</p>
<ol type="1">
<li>Conditionally included source files:</li>
</ol>
<div class="fragment"><div class="line">foo/</div><div class="line">|----foo_bar.c</div><div class="line">|----foo.c</div><div class="line">|----Makefile</div></div><!-- fragment --><p>In <code>foo/Makefile</code> you add the source file to the <code>SRC</code> variable, conditioned on the Pseudomodule inclusion</p>
<div class="fragment"><div class="line">ifneq (,$(filter foo_bar,$(USEMODULE)))</div><div class="line">  SRC += foo_bar.c</div><div class="line">endif</div></div><!-- fragment --><p>See <code>sys/net/ble/skald</code> for an example in code.</p>
<ol type="1">
<li>Using the <code>SUBMODULES</code> mechanism:</li>
</ol>
<div class="fragment"><div class="line">foo/</div><div class="line">|----spam.c</div><div class="line">|----ham.c</div><div class="line">|----eggs.c</div><div class="line">|----Makefile</div></div><!-- fragment --><div class="fragment"><div class="line"># make all code end up in &quot;foo_bar.a&quot;, this can be any name</div><div class="line">MODULE := foo_bar</div><div class="line"></div><div class="line"># ensure that &quot;foo_ham&quot; or &quot;bar_foo_ham&quot; builds &quot;foo_ham.c&quot;.</div><div class="line">BASE_MODULE := foo</div><div class="line"></div><div class="line"># list of source files that are not SUBMODULES</div><div class="line">SRC := spam.c</div><div class="line"></div><div class="line"># enable submodules by setting SUBMODULES = 1</div><div class="line">SUBMODULES = 1</div></div><!-- fragment --><p>When using <code>SUBMODULES</code> in a <code>MODULE</code> all <code>SRC</code> file excluded from <code>foo/Makefile</code> will be considered <code>SUBMODULES</code>. In the example above <code>ham.c</code> and <code>eggs.c</code>. These source files will be conditionally included depending if the modules have been added, i.e. <code>USEMODULE += foo_ham foo_eggs</code> (it's the same as case 1 but handled automatically in <code>Makefile.base</code>).</p>
<p>The <code>SUBMODULES</code> mechanism is more flexible since <code>BASE_MODULE</code> allows matching the only parts of compounded module names and only match against part of that name.</p>
<p>See <code>sys/ztimer/Makefile</code> for an example in code.</p>
<p><code>SUBMODULES</code> can also be true-pseudomodules.</p>
<h1>Helper tools</h1>
<p>To help you start writing a module, the RIOT build system provides the <code>generate-module</code> make target. It is a wrapper around the <a href="https://pypi.org/project/riotgen/">riotgen</a> command line tool that is helpful when starting to implement a module: all required files are generated with copyright headers, doxygen groups, etc, so you can concentrate on the module implementation. The module source files are created in the <code>sys</code> directory.</p>
<p><b>Usage:</b></p>
<p>From the RIOT base directory, run: </p><div class="fragment"><div class="line">make generate-module</div></div><!-- fragment --><p> Then answer a few questions about the driver:</p><ul>
<li>Module name: enter a name for your module. It will be used as both the name of the module directory under sys, where the source files are created, and the build system module (used with <code>USEMODULE</code>).</li>
<li>Module doxygen name: Enter the name of module, as displayed in the Doxygen documentation.</li>
<li>Brief doxygen description: Describe in one line what is this module about.</li>
</ul>
<p>Other global information (author name, email, organization) should be retrieved automatically from your git configuration.</p>
<p>Once completed, the module files are located in <code>sys/&lt;module name&gt;/&lt;module name&gt;.c</code> and <code>sys/include/&lt;module name&gt;.h</code>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
    <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
        <ul>
            <li class="footer">Generated on Fri Jul 3 2020 23:49:37 by <a href="http://www.doxygen.org/index.html">
                       <img class="footer" src="doxygen.png" alt="doxygen"></a> 1.8.13</li>
        </ul>
    </div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap.min.js"></script>
    <script src="jquery.smartmenus.min.js"></script>
    <script src="jquery.smartmenus.bootstrap.min.js"></script>
    <script src="riot-doxy.js"></script>
  </body>
</html>
