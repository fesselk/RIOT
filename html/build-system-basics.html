<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Build System Basics</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery.min.js"></script>
    <script src="jquery.powertip.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="doxy-jquery.js"></script>
    <script src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <!-- Bootstrap -->
    <link href="doxygen.css" rel="stylesheet">
    <link href="fonts.css" rel="stylesheet">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
    <link href="riot.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
      <div id="top">
        <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" id="brand-logo" href="http://riot-os.org"><img height="40px" src="riot-logo.svg" /></a>
              <p class="navbar-text text-center visible-xs">Documentation</p>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="navbar-collapse">
              <p class="navbar-text navbar-left"><span id="projectbrief">The friendly Operating System for the Internet of Things</span></p>
              <ul id="riot-navlist" class="nav navbar-nav"></ul>
              <!--BEGIN SEARCHENGINE hidden-sm hidden-xs"-->
              <form id="riot-searchform" class="navbar-form navbar-left navbar-right"
                    onsubmit="try{
                        var rhtml=document.getElementById('MSearchResults').contentWindow.document.body.innerHTML;
                        document.getElementById('MSearchResultsWindow').style.display='none';
                        document.getElementById('top').append(document.getElementById('MSearchSelectWindow'));
                        document.getElementById('top').append(document.getElementById('MSearchResultsWindow'));
                        document.getElementById('doc-content').innerHTML=rhtml;
                        }finally{
                            return false;
                    }">
                 <div class="form-group">
                   <div id="MSearchBox" class="MSearchBoxActive">
                     <div class="input-group">
                       <div class="input-group-addon">
                         <span id="MSearchSelect" class="glyphicon glyphicon-search" aria-hidden="true" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"></span>
                       </div>
                       <input class="form-control" type="text" id="MSearchField" placeholder="Search" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event);
                              r=document.getElementById('MSearchResultsWindow');
                              if(parseInt(r.style.left)<0)r.style.left=0;">
                       <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()">
                         <span id="search-reset" class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                       </a>
                     </div>
                   </div>
                 </div>
              </form>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
      </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('build-system-basics.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Build System Basics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="board-cpu-features"></a>
BOARD, CPU &amp; FEATURES</h1>
<h2><a class="anchor" id="features"></a>
FEATURES</h2>
<h3>What is a FEATURE?</h3>
<p>A <code>FEATURE</code> is a mean of specifying valid/invalid dependencies and configurations.</p>
<p>Whenever a <code>FEATURE</code> is used there should be at some level a hardware requirement, whether this is a <em>radio</em>, a <em>bus</em> of a specific core architecture.</p>
<p>This is not a hard line, in some cases the line can be harder to establish than others. There are complicated cases like <code>netif</code> since a network interface could be fully implemented in software as a loop-back.</p>
<p>It's also important to note that a <code>FEATURE</code> does not mean there is a <code>MODULE</code> with the same name. There could be many implementations for the same <code>FEATURE</code>. The fact that many <code>FEATURES</code> translate directly into a <code>MODULE</code> is only by convenience.</p>
<p>e.g. </p><pre class="fragment"># all periph features correspond to a periph submodule
USEMODULE += $(filter periph_%,$(FEATURES_USED))
</pre><h3>Providing a FEATURE</h3>
<p>For a <code>FEATURE</code> to be provided by a <code>board</code> it must meet 2 criteria, and for <code>periph_%</code> and other <em>hw</em> (hardware) related <code>FEATURES</code> it must follow a 3rd criteria.</p>
<ul>
<li>Needs the "hardware" or BSP support (toolchain, build system, flasher, etc.)<ul>
<li>e.g.: <code>stm32l152re</code> has an SPI peripheral <code>riotboot</code> needs to be able to link and flash at an offset</li>
</ul>
</li>
<li>Needs support in RIOT, an implementation of an api to interact with the <em>hw</em><ul>
<li>e.g.: <code>cpu/stm32_common/periph/spi.c</code> is implemented for <code>stm32l1</code> <code>riotboot</code> needs an implementation of <code>cpu_jump_to_image</code></li>
</ul>
</li>
<li>Wiring between the <em>cpu/soc</em>(system on a chip) a <em>bus</em> and other <em>cpu</em>/_hw_ components.<ul>
<li>e.g.: <code><a class="el" href="boards_2nucleo-l152re_2include_2periph__conf_8h.html" title="Peripheral MCU configuration for the nucleo-l152re board. ">nucleo-l152re/include/periph_conf.h</a></code> specified wiring between <code>PORT_Ax</code> and <code>SPI1</code></li>
</ul>
</li>
</ul>
<h3>All the FEATURES_%</h3>
<ul>
<li><code>FEATURES_PROVIDED</code> are available hardware (including BSP) features (e.g.:<code>periph_hwrng</code>, <code>periph_uart</code>) or characteristics (e.g:<code>arch_32bits</code>) of a board.</li>
<li><code>FEATURES_CONFLICT</code> are a series of <code>FEATURES</code> that can't be used at the same time for a particular <code>BOARD</code>.</li>
<li><code>FEATURES_REQUIRED</code> are <code>FEATURES</code> that are needed by a <code>MODULE</code> or <code>APPLICATION</code> to work.</li>
<li><code>FEATURES_OPTIONAL</code> are "nice to have" <code>FEATURES</code>, not needed but useful. If available they are always included.</li>
<li><code>FEATURES_REQUIRED_ANY</code> are <code>FEATURES</code> of which (at least) one of is needed by a <code>MODULE</code> or <code>APPLICATION</code>. Alternatives are separated by a pipe (<code>|</code>) in order of preference, e.g.: <code>FEATURES_REQUIRED_ANY += arch_avr8|arch_native</code> if both are provide then <code>arch_avr8</code> will be used.</li>
<li><code>FEATURES_BLACKLIST</code> are <code>FEATURES</code> that can't be used by a <code>MODULE</code> or <code>APPLICATION</code>. They are usually used for <em>hw</em> characteristics like <code>arch_</code> to easily resolve unsupported configurations for a group.</li>
<li><code>FEATURES_USED</code> are the final list of <code>FEATURES</code> that will be used by an <code>APPLICATION</code></li>
</ul>
<h3>Where to define FEATURES_%</h3>
<ul>
<li><code>FEATURES_PROVIDED</code>, <code>FEATURES_CONFLICT</code> and <code>FEATURES_CONFLICT_MSG</code> are defined in <code>Makefile.features</code></li>
<li><code>FEATURES_REQUIRED</code>, <code>FEATURES_OPTIONAL</code>, <code>FEATURES_REQUIRED_ANY</code>, and <code>FEATURES_BLACKLIST</code> are defined by the application <code>Makefile</code> (<code>examples/%/Makefile</code>, <code>tests/%/Makefile</code>, etc.) or in <code>Makefile.dep</code></li>
</ul>
<h2><a class="anchor" id="cpu"></a>
CPU/CPU_MODEL</h2>
<p><code>CPU</code> and <code>CPU_MODEL</code> refer to the <em>soc</em> or <em>mcu</em> (microcontroller) present in a <code>BOARD</code>. The variables <code>CPU</code>, <code>CPU_FAM</code>, etc. are just arbitrary groupings to avoid code duplication. How this grouping is done depends on every implementation and the way each manufacturer groups there products.</p>
<p>These variables allows declaring the <code>FEATURES</code> that the <em>mcu/soc</em> provides as well as resolving dependencies.</p>
<p><code>FEATURES</code> provided by a <code>CPU/CPU_MODEL</code> should not depend on the wiring of a specific <code>BOARD</code> but be intrinsic to the <em>soc/mcu</em>.</p>
<p>A <code>CPU/CPU_MODEL</code> might support <code>FEATURES</code> that will depend on the <code>BOARD</code> wiring, e.g.: bus (<code>uart</code>, <code>spi</code>) mappings. In this cases the <code>FEATURE</code> should be provided by the <code>BOARD.</code></p>
<h2><a class="anchor" id="board"></a>
BOARD</h2>
<p>In RIOTs build-system, a <code>BOARD</code> is a grouping of:</p>
<ul>
<li><em>soc/mcu</em> (<code>CPU/CPU_MODEL</code>)<ul>
<li>e.g.: <code>b-l072z-lrwan1</code> <code>stm32l072cz</code></li>
</ul>
</li>
<li><em>sensor/actuators</em> (buttons and leds included) (<code>drivers</code>)<ul>
<li>e.g.: <code>b-l072z-lrwan1</code> leds and buttons</li>
</ul>
</li>
<li><em>radios</em>, <em>ethernet</em>, etc. devices (<code>drivers</code>)<ul>
<li>e.g.: <code>b-l072z-lrwan1</code> <code>sx1276</code></li>
</ul>
</li>
<li><em>programming/debugging</em> tools<ul>
<li>e.g.: <code>b-l072z-lrwan1</code> <code>stlink</code></li>
</ul>
</li>
<li>configuration mapping cpu support capabilities to availability<ul>
<li>e.g.: <code>b-l072z-lrwan1</code> <code>periph_conf.h</code>, <code>gpio_params</code></li>
</ul>
</li>
</ul>
<p>A <code>board</code> can have all the required <code>FEATURES</code> to interact with a radio or sensor/actuator, but it doesn't necessarily provide that <code>FEATURE</code>.</p>
<p>e.g.:</p><ul>
<li><code>samr21-xpro</code> provides a <code>at86rf233</code> radio as well as the necessary <code>periph_*</code> features.</li>
<li><code>nucleo-*</code> provide all <code>periph_*</code> features to use <code>sx1272</code>, and even a default configuration for the <code>SX1272MB2xA</code> shield, but not doesn't provide the radio.</li>
</ul>
<p>If a <code>board</code> in <code>/boards</code> is connected to a radio shield, sensors, actuators, etc. then it is a different <code>board</code> than the one provided by default. Whenever you need to have a device mapping (in linux-arm, it would require a different device tree), then it is a different board and would need a different <code>board/periph_conf</code>.</p>
<p>A <code>nucleo-*</code> with a <code>SX1272MB2xA</code> is a different board in RIOT sense.</p>
<p><em>note</em>: if <code>devicetree</code> is implemented this concept will change.</p>
<h1><a class="anchor" id="variable-declaration-guidelines"></a>
Variables declaration guidelines</h1>
<p>This page contains basic guidelines about <code>make</code> variable declaration, it summarizes some of the pros and cons as well as specifies good and bad patterns in our build system. You might want to refer to <code>gnu make</code> documentation regarding these subjects.</p>
<h2>Avoid unnecessary export</h2>
<div class="fragment"><div class="line">export OUTPUT = $(shell some-command)</div></div><!-- fragment --><p>Exporting a variable means it will be evaluated on every <code>target</code> call, which slows down the build system. Always avoid exporting a variable if unneeded.</p>
<p>If an export is actually needed by a <code>sub-make</code> then export the variable only for the needed targets using <code>target-export-variables</code> (more in <code>makefiles/utils/variables.mk</code>).</p>
<p>Exported variables ("global variable") are hard to remove, specially when badly documented. If no one knows why it's there and no one knows where it can be used then no one knows if it's safe to remove since it's present for every target. This is why global variables need clear documentation.</p>
<p><a href="https://www.gnu.org/software/make/manual/html_node/Variables_002fRecursion.html">gnumake doc</a></p>
<h2>Use memoized for variables referencing a function or command</h2>
<h3>recursively expanded variable:</h3>
<div class="fragment"><div class="line">OUTPUT = $(shell some-command $(ANOTHER_VARIABLE))</div></div><!-- fragment --><ul>
<li>When using <code>=</code> the value of the variable is only declared, but not set, therefore the variable will only be evaluated when expanded (used) somewhere in the makefile. If <code></code> is never expanded, <code>some-command</code> is never executed and <code>ANOTHER_VARIABLE</code> not expanded.</li>
<li>All variables or functions referenced by the declared variable will will be evaluated every time the variable is expanded. In the example <code>some-command</code> is executed every time <code>OUTPUT</code> is expanded, same for <code>ANOTHER_VARIABLE</code>. If <code>some-command</code> is slow this introduced unneeded overhead.</li>
<li>If the variable expansion doesn't involve evaluating a function the overhead is none.</li>
</ul>
<h3>simply expanded variable:</h3>
<div class="fragment"><div class="line">OUTPUT := $(shell some-command $(ANOTHER_VARIABLE))</div></div><!-- fragment --><ul>
<li>When using <code>:=</code> the value is only expanded once, expanding any reference to other variables or functions. If <code>OUTPUT</code> is always used at least once and evaluates a costly function (<code>some command</code>) then use <code>:=</code>.</li>
<li>When using <code>:=</code> the variable will be evaluated even if not needed, which introduces unnecessary delay, in particular <code>some command</code> or functions evaluated by <code>ANOTHER_VARIABLE</code> are slow. It can also cause a failure in a worst-case scenario (think what happens if a tool is defined with <code>:=</code> but you don't have the tool and you don't need it either).</li>
<li>The values of variables declared with <code>:=</code> depend on the order of definition.</li>
</ul>
<h3>memoized:</h3>
<div class="fragment"><div class="line">OUTPUT = $(call memoized,OUTPUT,$(shell some-command))</div></div><!-- fragment --><ul>
<li><code>memoized</code> is a RIOT defined function that combines characteristics from both <code>=</code> and <code>:=</code>. The variable expansion will be deferred until its first usage, but further usage will consider it as a simply expanded variable, so it will use the already evaluated value. In the example <code>some-command</code> would be executed once or not at all (more in <code>makefiles/utils/variables.mk</code>).</li>
</ul>
<p><a href="https://www.gnu.org/software/make/manual/html_node/Flavors.html">gnumake doc</a></p>
<h2>Additional documentation</h2>
<ul>
<li>Deferred vs. simple expansion: <a href="http://make.mad-scientist.net/deferred-simple-variable-expansion/">http://make.mad-scientist.net/deferred-simple-variable-expansion/</a></li>
<li>Tracking issue: <a href="https://github.com/RIOT-OS/RIOT/issues/10850">#10850</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
    <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
        <ul>
            <li class="footer">Generated on Wed Jul 1 2020 17:08:58 by <a href="http://www.doxygen.org/index.html">
                       <img class="footer" src="doxygen.png" alt="doxygen"></a> 1.8.13</li>
        </ul>
    </div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap.min.js"></script>
    <script src="jquery.smartmenus.min.js"></script>
    <script src="jquery.smartmenus.bootstrap.min.js"></script>
    <script src="riot-doxy.js"></script>
  </body>
</html>
