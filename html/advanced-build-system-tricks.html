<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Advanced build system tricks</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery.min.js"></script>
    <script src="jquery.powertip.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="jquery.scrollTo.min.js"></script>
    <script src="doxy-jquery.js"></script>
    <script src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <!-- Bootstrap -->
    <link href="doxygen.css" rel="stylesheet">
    <link href="fonts.css" rel="stylesheet">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
    <link href="riot.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
        <script>
            function displaySR(){
            searchBox.Search();
            var rhtml=(document.getElementById('MSearchResults').contentWindow.document.body.innerHTML).replace(/href=\"\.\.\//g,'href="');
            document.getElementById('MSearchResultsWindow').style.display='none';
            document.getElementById('top').append(document.getElementById('MSearchSelectWindow'));
            document.getElementById('top').append(document.getElementById('MSearchResultsWindow'));
            document.getElementById('doc-content').innerHTML=rhtml;
            }
            function modSearch(){
            if(!searchBox.doxySearch){
                searchBox.doxySearch=searchBox.Search
                searchBox.Search= function(){this.doxySearch();
                var r=document.getElementById('MSearchResultsWindow');console.log(r.style);
                if(parseInt(r.style.left)<0)r.style.left=0;
                var x=document.getElementById('MSearchResults');
                if(x.scrollWidth>window.screen.width)x.style.width=window.screen.width-2+'px';
                var f=document.getElementById('riot-searchform');
                if(parseInt( r.style.top) < f.offsetTop+f.scrollHeight) r.style.top = f.offsetTop+f.scrollHeight+'px';}
            }
            }
        </script>
  </head>
  <body>
      <div id="top">
        <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" id="brand-logo" href="http://riot-os.org"><img height="40px" src="riot-logo.svg" /></a>
              <p class="navbar-text text-center visible-xs">Documentation</p>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="navbar-collapse">
              <p class="navbar-text navbar-left"><span id="projectbrief">The friendly Operating System for the Internet of Things</span></p>
              <ul id="riot-navlist" class="nav navbar-nav"></ul>
              <form id="riot-searchform" class="navbar-form navbar-left navbar-right"
                    onsubmit="try{
                        displaySR();
                    }finally{
                            return false;
                    }">
                 <div class="form-group">
                   <div id="MSearchBox" class="MSearchBoxActive">
                     <div class="input-group">
                       <div class="input-group-addon">
                         <span id="MSearchSelect" class="glyphicon glyphicon-search" aria-hidden="true" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"></span>
                       </div>
                       <input class="form-control" type="text" id="MSearchField" placeholder="Search" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event); modSearch();">
                       <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()">
                         <span id="search-reset" class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                       </a>
                     </div>
                   </div>
                 </div>
              </form>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
      </div>
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('advanced-build-system-tricks.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Advanced build system tricks </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#introduction">Introduction</a></li>
<li class="level1"><a href="#customize-build-system">Customize the build system</a><ul><li class="level2"><a href="#autotoc_md1669">Usage</a></li>
</ul>
</li>
<li class="level1"><a href="#multiple-boards-udev">Handling multiple boards with udev-rules</a><ul><li class="level2"><a href="#autotoc_md1670">Handling multiple versions of the same BOARD</a></li>
<li class="level2"><a href="#autotoc_md1671">Notes</a></li>
<li class="level2"><a href="#autotoc_md1672">Documentation:</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md1673"># Handling multiple boards without udev-rules</a></li>
<li class="level1"><a href="#analyze-depedency-resolution">Analyze dependency resolution</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="introduction"></a>
Introduction</h1>
<p>This page describes some build systems tricks that can help developers but are not part of the standard workflow.</p>
<p>They are low level commands that should not be taken as part of a stable API but better have a documentation than only having a description in the build system code.</p>
<h1><a class="anchor" id="customize-build-system"></a>
Customize the build system</h1>
<ul>
<li><code>RIOT_MAKEFILES_GLOBAL_PRE</code>: files parsed before the body of <code>$RIOTBASE/Makefile.include</code></li>
<li><code>RIOT_MAKEFILES_GLOBAL_POST</code>: files parsed after the body of <code>$RIOTBASE/Makefile.include</code></li>
</ul>
<p>The variables are a list of files that will be included by <code>$RIOTBASE/Makefile.include</code>. They will be handled as relative to the application directory if the path is relative.</p>
<h2><a class="anchor" id="autotoc_md1669"></a>
Usage</h2>
<p>You can configure your own files that will be parsed by the build system main <code>Makefile.include</code> file before or after its main body, examples usages can be:</p>
<ul>
<li>Globally overwrite a variable, like <code>TERMPROG</code></li>
<li>Specify a hard written <code>PORT</code> / <code>DEBUG_ADAPTER_ID</code> for some BOARD values</li>
<li>Define your custom targets</li>
<li>Override default targets</li>
</ul>
<h1><a class="anchor" id="multiple-boards-udev"></a>
Handling multiple boards with udev-rules</h1>
<p>When developing and working with multiple boards the default <code>PORT</code> configuration for a particular board might not apply anymore so <code>PORT</code> will need to be specified whenever calling <code>make term/test</code>. This can also happen if multiple <code>DEBUGGERS/PROGRAMMERS</code> are present so <code>DEBUG_ADAPTER_ID</code> will also need to be passed. Keeping track of this will become annoying.</p>
<p>One way of handling this is to use <code>udev</code> rules to define <code>SYMLINKS</code> between the boards serial port (<code>riot/tty-&lt;board-name&gt;</code>) and the actual serial port (dev/ttyACM* or other). With this we can query the rest of the boards serial <code>dev</code> information (<code>DEBUG_ADAPTER_ID</code>, <code>PORT</code>, etc.) to always flash and open a terminal on the correct port.</p>
<p>Procedure:</p>
<ul>
<li><p class="startli">use <code>udevadm info /dev/ttyACM0</code> to query the udev database for information on device on port <code>/dev/ttyACM0</code>.</p>
<p class="startli">or use <code>udevadm info --attribute-walk --name /dev/ttyACM0</code> for more detailed output when the first level of information isn't enough</p>
</li>
<li>create a udev rule with information of the device and one parent to create a matching rule in <code>/etc/udev/rules.d/70-riotboards.rules</code>.</li>
</ul>
<div class="fragment"><div class="line"># samr21-xpro</div>
<div class="line">SUBSYSTEM==&quot;tty&quot;, SUBSYSTEMS==&quot;usb&quot;, ATTRS{idVendor}==&quot;03eb&quot;, \</div>
<div class="line">ATTRS{idProduct}==&quot;2111&quot;, ATTRS{manufacturer}==&quot;Atmel Corp.&quot;, \</div>
<div class="line">ATTRS{serial}==&quot;ATML2127031800004957&quot;, SYMLINK+=&quot;riot/tty-samr21-xpro&quot;</div>
</div><!-- fragment --><ul>
<li>reload rules: <code>udevadm control --reload-rules</code></li>
<li>Boards <code>PORT</code> are symlinked to /dev/riot/tty-<code>board-name</code>.</li>
<li>Create a <code>makefile.pre</code> that will query the real <code>PORT</code> and the <code>DEBUG_ADAPTER_ID</code> from the <code>SYMLINK</code> info</li>
</ul>
<div class="fragment"><div class="line">PORT = /dev/riot/tty-$(BOARD)</div>
<div class="line">DEBUG_ADAPTER_ID = $(\</div>
<div class="line">    shell udevadm info -q property $(PORT) |\</div>
<div class="line">    sed -n ’/ID_SERIAL_SHORT/ {s/ID_SERIAL_SHORT=//p}’)</div>
</div><!-- fragment --><ul>
<li>You can now add <code>makefile.pre</code> to <code>RIOT_MAKEFILES_GLOBAL_PRE</code> as an environment variable or on each <code>make</code> call:</li>
</ul>
<div class="fragment"><div class="line">$ RIOT_MAKEFILES_GLOBAL_PRE=/path/to/makefile.pre make -C examples/hello-world flash term</div>
</div><!-- fragment --><p><em>note</em>: if set as an environment variable it would be a good idea to add a variable to enable/disable it, e.g:</p>
<div class="fragment"><div class="line">ifeq (1,$(ENABLE_LOCAL_BOARDS))</div>
<div class="line">    PORT = /dev/riot/tty-$(BOARD)</div>
<div class="line">    DEBUG_ADAPTER_ID = $(\</div>
<div class="line">        shell udevadm info -q property $(PORT) |\</div>
<div class="line">        sed -n ’/ID_SERIAL_SHORT/ {s/ID_SERIAL_SHORT=//p}’)</div>
<div class="line">endif</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1670"></a>
Handling multiple versions of the same BOARD</h2>
<p>The above procedure works fine when handling different boards, but not multiple times the same board, e.g: multiple <code>samr21-xpro</code>.</p>
<p>An option for this would be to add an identifier of that board to the mapped <code>riot/tty-*</code>, there are multiple ways of handling this but in the end it means having a way to identify every copy.</p>
<p>Another way would be to map the <code>DEBUG_ADAPTER_ID</code> in the name:</p>
<div class="fragment"><div class="line">SYMLINK+=&quot;riot/node-$attr{serial}</div>
</div><!-- fragment --><p>But it will require to know in advance the serial number of each board you want to use. Another option would be to add some kind of numbering and defining multiple symlinks for each board. e.g. for <code>samr21-xpro</code> number <code>n</code>:</p>
<div class="fragment"><div class="line"># samr21-xpro</div>
<div class="line">SUBSYSTEM==&quot;tty&quot;, SUBSYSTEMS==&quot;usb&quot;, ATTRS{idVendor}==&quot;03eb&quot;, \</div>
<div class="line">ATTRS{idProduct}==&quot;2111&quot;, ATTRS{manufacturer}==&quot;Atmel Corp.&quot;, \</div>
<div class="line">ATTRS{serial}==&quot;ATML2127031800004957&quot;, SYMLINK+=&quot;riot/tty-samr21-xpro&quot;, \</div>
<div class="line">SYMLINK+=&quot;riot/tty-samr21-xpro-n&quot;</div>
</div><!-- fragment --><p>Then, when flashing, the number can be specified and the parsing adapted:</p>
<div class="fragment"><div class="line">ifneq(,$(BOARD_NUM))</div>
<div class="line">  PORT = /dev/riot/tty-$(BOARD)-$(BOARD_NUM)</div>
<div class="line">else</div>
<div class="line">  PORT = /dev/riot/tty-$(BOARD)</div>
<div class="line">endif</div>
<div class="line">DEBUG_ADAPTER_ID = $(\</div>
<div class="line">  shell udevadm info -q property $(PORT) |\</div>
<div class="line">  sed -n ’/ID_SERIAL_SHORT/ {s/ID_SERIAL_SHORT=//p}’)</div>
</div><!-- fragment --><div class="fragment"><div class="line">BOARD=samr21-xpro BOARD_NUM=n make flash term</div>
</div><!-- fragment --><p>In the end, this would be the same as using the serial, but a simple number might be easier to handle.</p>
<h2><a class="anchor" id="autotoc_md1671"></a>
Notes</h2>
<p>Udev only parses SUBSYSTEM and one parent. For others, we will rely on ENV variables defined by 60-serial.rules</p>
<p>So the current filename should be higher than 60-serial.rules</p>
<p>If for some reason re-writing the serial is needed there is a windows tool: <a href="https://remoteqth.com/wiki/index.php?page=How+to+set+usb+device+SerialNumber">https://remoteqth.com/wiki/index.php?page=How+to+set+usb+device+SerialNumber</a></p>
<h2><a class="anchor" id="autotoc_md1672"></a>
Documentation:</h2>
<ul>
<li>The whole documentation <a href="http://reactivated.net/writing_udev_rules.html#udevinfo">http://reactivated.net/writing_udev_rules.html#udevinfo</a></li>
<li>Udev manpage <a href="http://manpages.ubuntu.com/manpages/eoan/en/man7/udev.7.html">http://manpages.ubuntu.com/manpages/eoan/en/man7/udev.7.html</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md1673"></a>
# Handling multiple boards without udev-rules</h1>
<p>This is a simpler approach to the above mentioned issue. The solution here only uses a makefile script for selecting the debugger and serial port. No administrative privileges (e.g. to configure Udev) are required.</p>
<p>One of the limitations of the solution described here is that it currently doesn't work with multiple boards of the same type. This limitation is a limitation of the script and not of the mechanism used, it is possible to adapt the script to support multiple boards of the same type. This modification is left as an exercise to the reader.</p>
<p>The following Make snippet is used:</p>
<div class="fragment"><div class="line">LOCAL_BOARD_MAP ?= 1</div>
<div class="line"> </div>
<div class="line"># Adapt this list to your board collection</div>
<div class="line">SERIAL_nucleo-f103rb ?= 066BFF343633464257254156</div>
<div class="line">SERIAL_same54-xpro ?= ATML2748051800005053</div>
<div class="line">SERIAL_samr21-xpro ?= ATML2127031800008360</div>
<div class="line">SERIAL_nrf52dk ?= 000682223007</div>
<div class="line"> </div>
<div class="line">ifeq (1,$(LOCAL_BOARD_MAP))</div>
<div class="line"> </div>
<div class="line">  # Retrieve the serial of the selected board</div>
<div class="line">  BOARD_SERIAL = $(SERIAL_$(BOARD))</div>
<div class="line"> </div>
<div class="line">  # Check if there is a serial for the board</div>
<div class="line">  ifneq (,$(BOARD_SERIAL))</div>
<div class="line"> </div>
<div class="line">    # Set the variables used by various debug tools to the selected serial</div>
<div class="line">    SERIAL ?= $(BOARD_SERIAL)</div>
<div class="line">    DEBUG_ADAPTER_ID ?= $(BOARD_SERIAL)</div>
<div class="line">    JLINK_SERIAL ?= $(BOARD_SERIAL)</div>
<div class="line"> </div>
<div class="line">    # Use the existing script to grab the matching /dev/ttyACM* device</div>
<div class="line">    PORT_LINUX ?= $(firstword $(shell $(RIOTTOOLS)/usb-serial/find-tty.sh $(SERIAL)))</div>
<div class="line">  endif</div>
<div class="line">endif</div>
</div><!-- fragment --><p>The array of board serial numbers has to be edited to match your local boards. The serial numbers used here is the USB device serial number as reported by the debugger hardware. With the <code>make list-ttys</code> it is reported as the 'serial':</p>
<div class="fragment"><div class="line">$ make list-ttys</div>
<div class="line">/sys/bus/usb/devices/1-1.4.4: Atmel Corp. EDBG CMSIS-DAP, serial: &#39;ATML2127031800008360&#39;, tty(s): ttyACM1</div>
<div class="line">/sys/bus/usb/devices/1-1.4.3: SEGGER J-Link, serial: &#39;000683806234&#39;, tty(s): ttyACM0</div>
</div><!-- fragment --><p>When the above make snippet is included as <code>RIOT_MAKEFILES_GLOBAL_PRE</code>, the serial number of the USB device is automatically set if the used board is included in the script. This will then ensure that the board debugger is used for flashing and the board serial device is used when starting the serial console.</p>
<h1><a class="anchor" id="analyze-depedency-resolution"></a>
Analyze dependency resolution</h1>
<p>When refactoring dependency handling or modifying variables used for dependency resolution, one may want to evaluate the impact on the existing applications. This describe some debug targets to dump variables used during dependency resolution.</p>
<p>To analyze one board and application run the following commands in an application directory.</p>
<p>Generate the variables dump with the normal dependency resolution to a <code>dependencies_info_board_name</code> file:</p>
<div class="fragment"><div class="line">BOARD=board_name make dependency-debug</div>
</div><!-- fragment --><p>Or with the "quick" version used by murdock to know supported boards (this is an incomplete resolution, details in <code>makefiles/dependencies_debug.inc.mk</code>) to a <code>dependencies_info-boards-supported_board_name</code> file:</p>
<div class="fragment"><div class="line">BOARDS=board_name DEPENDENCY_DEBUG=1 make info-boards-supported</div>
</div><!-- fragment --><p>For more configuration and usage details, see in the file defining the targets <code>makefiles/dependencies_debug.inc.mk</code></p>
<p>To do a repository wide analysis, you can use the script <code>dist/tools/buildsystem_sanity_check/save_all_dependencies_resolution_variables.sh</code> that will generate the output for all boards and applications. It currently take around 2 hours on an 8 cores machine with ssd. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
    <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
        <ul>
            <li class="footer">Generated on Tue Nov 24 2020 19:46:59 by <a href="http://www.doxygen.org/index.html">
                       <img class="footer" src="doxygen.png" alt="doxygen"></a> 1.8.17</li>
        </ul>
    </div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap.min.js"></script>
    <script src="jquery.smartmenus.min.js"></script>
    <script src="jquery.smartmenus.bootstrap.min.js"></script>
    <script src="riot-doxy.js"></script>
  </body>
</html>
